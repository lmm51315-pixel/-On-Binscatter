# 从可视化到统计推断：Binscatter 的方法论重构、最优分箱与一致置信带

* **作者**： 马俊豪 ，郝泓程
* **摘要**： 本文系统性地复现并阐释了Cattaneo、Crump、Farrell及Feng（2024）发表于《美国经济评论》（*American Economic Review*）的论文“On Binscatter”的核心成果。该研究对经济学及相关社会科学领域广泛使用的分箱散点图（Binscatter）工具进行了根本性的方法论革新。传统实践虽直观，但缺乏严谨的统计学基础，尤其是在处理控制变量时普遍采用的“两步残差法”存在理论缺陷，可能导致图形扭曲与结论误导。本文旨在深入解析作者提出的三个关键改进：(1) 基于半参数部分线性模型的联合估计框架，以正确进行协变量调整；(2) 基于积分均方误差最小化原则的数据驱动最优分箱数选择准则；(3) 构建用于整体函数形态假设检验的一致置信带。我们通过详尽的Stata代码实操，完整再现了原文的理论应用案例，并详细介绍了实现这些方法的最新Stata命令 **`binsreg`** 的使用规范、语法选项及其在实证研究中的完整工作流程。


### 项目文件结构说明

为确保研究的可重复性，本项目所有材料按如下结构组织：

- **`01_code/`**：包含完整的Stata分析代码。主文件（`main.do`）控制整个分析流程，调用各子模块完成数据准备、模型估计、图形生成与结果输出。
- **`02_data_raw/`**：存放由Cattaneo等人公开提供的原始研究数据，确保复现工作基于一致的初始资料。
- **`03_temp/`**：在代码运行过程中自动生成的中间数据处理文件，用于存储计算过程中的临时结果。
- **`04_output/`**：保存全部最终输出结果，包括高分辨率的Binscatter图形（`.png`）。
- **`AER-CCFF-ReplicationCode/`**：作者提供的原始复现资料
- **`原文/`**：包含原始的文章及其附录

### 代码执行与复现指南

1.  **软件环境**：本文的分析完全使用 **Stata** 统计软件（建议版本17或以上）进行。代码具有较好的版本兼容性。
2.  **前置依赖**：运行复现代码需要预先安装若干Stata外部命令。最核心的命令是 **`binsreg`**（可通过Stata内置命令 `ssc install binsreg` 安装）。其它可能用到的辅助命令（如 `estout`, `sumap` 等）已在代码开头通过 `ssc install` 或 `net install` 命令包含，执行时会自动检查并安装。
3.  **路径设置**：使用者需在运行前，修改程序（`论文案例1.do`与`论文案例2.do`）中定义的全局宏 **`global main`** ，将其路径指向本项目在本地的根目录。此设置一旦完成，所有后续的数据读取、文件保存均将自动指向正确的子文件夹，无需再修改其他代码。
4.  **执行流程**：完成路径设置并确保网络连接（用于自动安装命令）后，直接运行整个 do-file，即可完整复现本文的所有分析结果与图表。

通过上述结构化的说明与组织，本文不仅提供了对前沿计量方法的深入解读，也致力于为同行研究者提供一个高标准、可完全复现的实证研究范例。

